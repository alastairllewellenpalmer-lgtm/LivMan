<!-- Bulk Action Bar + Modal -->
<!-- Requires: wrapping element to have x-data="bulkActions()" -->

<!-- Sticky Bottom Action Bar -->
<div x-show="selectedHorses.size > 0"
     x-transition:enter="transition ease-out duration-200"
     x-transition:enter-start="translate-y-full opacity-0"
     x-transition:enter-end="translate-y-0 opacity-100"
     x-transition:leave="transition ease-in duration-150"
     x-transition:leave-start="translate-y-0 opacity-100"
     x-transition:leave-end="translate-y-full opacity-0"
     x-cloak
     class="fixed bottom-0 left-0 lg:left-64 right-0 z-40 bg-white border-t border-slate-200 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
            <span class="text-sm font-medium text-slate-700" x-text="selectedHorses.size + ' horse' + (selectedHorses.size !== 1 ? 's' : '') + ' selected'"></span>
            <button @click="clearAll()" class="text-xs text-slate-500 hover:text-slate-700 underline">Clear</button>
        </div>
        <div class="flex items-center gap-3">
            <select x-model="actionType" class="form-select text-sm py-1.5">
                <option value="">Choose action...</option>
                <option value="vaccination">Record Vaccination</option>
                <option value="farrier">Record Farrier Visit</option>
                <option value="worming">Record Worming</option>
                <option value="egg_count">Record Egg Count</option>
                <option value="vet_visit">Record Vet Visit</option>
                <option value="condition">Record Condition</option>
            </select>
            <button @click="openModal()"
                    :disabled="!actionType"
                    :class="actionType ? 'btn-primary' : 'btn-secondary opacity-50 cursor-not-allowed'"
                    class="text-sm">
                Apply to Selected
            </button>
        </div>
    </div>
</div>

<!-- Modal Overlay -->
<div x-show="modalOpen"
     x-transition:enter="transition ease-out duration-200"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-150"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     x-cloak
     class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50"
     @click.self="modalOpen = false">

    <div x-show="modalOpen"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">

        <!-- Modal Header -->
        <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200">
            <h3 class="text-lg font-semibold text-slate-900" x-text="modalTitle"></h3>
            <button @click="modalOpen = false" class="text-slate-400 hover:text-slate-600">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Modal Body (HTMX-loaded form) -->
        <div id="bulk-form-container"
             hx-get=""
             hx-trigger="load"
             hx-swap="innerHTML">
            <div class="p-5 text-center text-slate-500">
                <p class="text-sm">Loading form...</p>
            </div>
        </div>
    </div>
</div>

<script>
function bulkActions() {
    return {
        selectedHorses: new Set(),
        actionType: '',
        modalOpen: false,
        modalTitle: '',

        toggleHorse(id) {
            if (this.selectedHorses.has(id)) {
                this.selectedHorses.delete(id);
            } else {
                this.selectedHorses.add(id);
            }
            // Force Alpine reactivity
            this.selectedHorses = new Set(this.selectedHorses);
        },

        isSelected(id) {
            return this.selectedHorses.has(id);
        },

        selectAll(ids) {
            ids.forEach(id => this.selectedHorses.add(id));
            this.selectedHorses = new Set(this.selectedHorses);
        },

        clearAll() {
            this.selectedHorses = new Set();
            // Uncheck all checkboxes
            document.querySelectorAll('input[data-horse-checkbox]').forEach(cb => cb.checked = false);
            var selectAllCb = document.querySelector('input[data-select-all]');
            if (selectAllCb) selectAllCb.checked = false;
        },

        toggleAll(event) {
            var checkboxes = document.querySelectorAll('input[data-horse-checkbox]');
            if (event.target.checked) {
                var ids = [];
                checkboxes.forEach(function(cb) {
                    cb.checked = true;
                    ids.push(parseInt(cb.value));
                });
                this.selectAll(ids);
            } else {
                this.clearAll();
            }
        },

        openModal() {
            if (!this.actionType || this.selectedHorses.size === 0) return;

            var labels = {
                vaccination: 'Record Vaccination',
                farrier: 'Record Farrier Visit',
                worming: 'Record Worming Treatment',
                egg_count: 'Record Egg Count',
                vet_visit: 'Record Vet Visit',
                condition: 'Record Medical Condition'
            };
            this.modalTitle = labels[this.actionType] + ' (' + this.selectedHorses.size + ' horses)';

            // Load form via HTMX
            var container = document.getElementById('bulk-form-container');
            container.innerHTML = '<div class="p-5 text-center text-slate-500"><p class="text-sm">Loading form...</p></div>';

            var self = this;
            htmx.ajax('GET', '/health/bulk/form/?action_type=' + this.actionType, {
                target: '#bulk-form-container',
                swap: 'innerHTML'
            }).then(function() {
                // Inject horse IDs as hidden fields
                var form = container.querySelector('form');
                if (form) {
                    self.selectedHorses.forEach(function(id) {
                        var input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'horse_ids';
                        input.value = id;
                        form.appendChild(input);
                    });
                }
            });

            this.modalOpen = true;
        },

        init() {
            var self = this;
            // Listen for bulk action complete
            document.body.addEventListener('bulkActionComplete', function() {
                self.modalOpen = false;
                self.clearAll();
                self.actionType = '';
                // Reload page to show updated data + toast
                window.location.reload();
            });
        }
    };
}
</script>
