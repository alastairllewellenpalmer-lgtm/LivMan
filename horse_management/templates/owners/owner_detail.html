{% extends 'base.html' %}

{% block title %}{{ owner.name }} - Cgate{% endblock %}

{% block content %}
<div class="space-y-6" x-data="bulkActions()">

    <!-- Page Header -->
    <div class="page-header">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-full bg-amber-100 text-amber-700 font-semibold text-lg flex items-center justify-center shrink-0">
                {{ owner.name|make_list|first|upper }}
            </div>
            <div>
                <h1 class="page-title">{{ owner.name }}</h1>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <a href="{% url 'invoice_create' %}?owner={{ owner.pk }}" class="btn-success">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
                </svg>
                Create Invoice
            </a>
            <a href="{% url 'owner_update' owner.pk %}" class="btn-secondary">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"/>
                </svg>
                Edit
            </a>
        </div>
    </div>

    <!-- Contact + Horses Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Contact Card -->
        <div class="card">
            <div class="section-header">
                <h2 class="section-title">Contact Information</h2>
            </div>
            <div class="px-5 py-4">
                <dl class="space-y-4">
                    {% if owner.email %}
                    <div>
                        <dt class="text-xs font-medium text-slate-500 uppercase tracking-wider">Email</dt>
                        <dd class="mt-1 text-sm text-slate-800">
                            <a href="mailto:{{ owner.email }}" class="link">{{ owner.email }}</a>
                        </dd>
                    </div>
                    {% endif %}
                    {% if owner.phone %}
                    <div>
                        <dt class="text-xs font-medium text-slate-500 uppercase tracking-wider">Phone</dt>
                        <dd class="mt-1 text-sm text-slate-800">{{ owner.phone }}</dd>
                    </div>
                    {% endif %}
                    {% if owner.address %}
                    <div>
                        <dt class="text-xs font-medium text-slate-500 uppercase tracking-wider">Address</dt>
                        <dd class="mt-1 text-sm text-slate-800 whitespace-pre-line">{{ owner.address }}</dd>
                    </div>
                    {% endif %}
                    {% if owner.notes %}
                    <div>
                        <dt class="text-xs font-medium text-slate-500 uppercase tracking-wider">Notes</dt>
                        <dd class="mt-1 text-sm text-slate-800">{{ owner.notes }}</dd>
                    </div>
                    {% endif %}
                    {% if not owner.email and not owner.phone and not owner.address and not owner.notes %}
                    <p class="text-sm text-slate-400 italic">No contact details recorded.</p>
                    {% endif %}
                </dl>
            </div>
        </div>

        <!-- Horses Card -->
        <div class="lg:col-span-2 card overflow-hidden">
            <div class="section-header">
                <h2 class="section-title">Current Horses</h2>
                <span class="badge-info">{{ horses|length }}</span>
            </div>
            {% if horses %}
            <div class="overflow-x-auto">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="w-10">
                                <input type="checkbox" data-select-all @change="toggleAll($event)" class="form-checkbox rounded">
                            </th>
                            <th>Name</th>
                            <th>Details</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for horse in horses %}
                        <tr>
                            <td>
                                <input type="checkbox"
                                       data-horse-checkbox
                                       value="{{ horse.pk }}"
                                       @change="toggleHorse({{ horse.pk }})"
                                       :checked="isSelected({{ horse.pk }})"
                                       class="form-checkbox rounded">
                            </td>
                            <td>
                                <a href="{% url 'horse_detail' horse.pk %}" class="link text-sm font-medium">{{ horse.name }}</a>
                                {% if horse.share_pct and horse.share_pct < 100 %}
                                <span class="badge-info ml-1 text-xs">{{ horse.share_pct|floatformat:0 }}%</span>
                                {% endif %}
                            </td>
                            <td class="text-xs text-slate-500">
                                {% if horse.age %}{{ horse.age }}yo{% endif %}
                                {{ horse.get_color_display }}
                                {{ horse.get_sex_display }}
                            </td>
                            <td class="text-xs text-slate-500">
                                {% with placement=horse.active_placements.0 %}
                                {% if placement %}
                                {{ placement.location.name }}
                                {% endif %}
                                {% endwith %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="px-5 py-10 text-center">
                <svg class="mx-auto h-10 w-10 text-slate-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.429 9.75L2.25 12l4.179 2.25m0-4.5l5.571 3 5.571-3m-11.142 0L2.25 7.5 12 2.25l9.75 5.25-4.179 2.25m0 0L12 12.75 6.429 9.75m11.142 0l4.179 2.25L12 17.25 2.25 12l4.179-2.25"/>
                </svg>
                <p class="mt-2 text-sm text-slate-500">No horses linked to this owner.</p>
            </div>
            {% endif %}
        </div>

    </div>

    <!-- Unbilled Charges -->
    {% if extra_charges %}
    <div class="card overflow-hidden">
        <div class="section-header">
            <h2 class="section-title">Unbilled Charges</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Horse</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th class="text-right">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for charge in extra_charges %}
                    <tr>
                        <td class="text-slate-500">{{ charge.date }}</td>
                        <td class="text-slate-800 font-medium">{{ charge.horse.name }}</td>
                        <td class="text-slate-500">{{ charge.get_charge_type_display }}</td>
                        <td class="text-slate-500">{{ charge.description }}</td>
                        <td class="text-slate-800 font-medium text-right">&pound;{{ charge.amount|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Recent Invoices -->
    <div class="card overflow-hidden">
        <div class="section-header">
            <h2 class="section-title">Recent Invoices</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Invoice</th>
                        <th>Period</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Due Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                    <tr>
                        <td>
                            <a href="{% url 'invoice_detail' invoice.pk %}" class="link">
                                {{ invoice.invoice_number }}
                            </a>
                        </td>
                        <td class="text-slate-500">
                            {{ invoice.period_start }} - {{ invoice.period_end }}
                        </td>
                        <td class="text-slate-800 font-medium">&pound;{{ invoice.total|floatformat:2 }}</td>
                        <td>
                            {% if invoice.status == 'paid' %}
                            <span class="badge-success">{{ invoice.get_status_display }}</span>
                            {% elif invoice.status == 'overdue' or invoice.is_overdue %}
                            <span class="badge-danger">{{ invoice.get_status_display }}</span>
                            {% elif invoice.status == 'sent' %}
                            <span class="badge-warning">{{ invoice.get_status_display }}</span>
                            {% else %}
                            <span class="badge-neutral">{{ invoice.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td class="text-slate-500">{{ invoice.due_date }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-slate-400 py-8">No invoices yet</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bulk Action Bar -->
    {% include 'health/partials/bulk_action_bar.html' %}

</div>
{% endblock %}
