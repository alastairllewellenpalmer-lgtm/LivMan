<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Invoice {{ invoice.invoice_number }}</title>
    <style>
        @page {
            margin: 1.5cm 2cm;
            size: A4;
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 11px;
            line-height: 1.4;
            color: #333;
            margin: 0;
        }
        .header {
            margin-bottom: 20px;
        }
        .company-name {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }
        .company-details {
            font-size: 10px;
            color: #666;
            line-height: 1.5;
        }
        .invoice-meta {
            margin-bottom: 20px;
        }
        .invoice-meta table {
            width: 100%;
        }
        .invoice-meta td {
            vertical-align: top;
        }
        .bill-to {
            font-size: 11px;
        }
        .bill-to .owner-name {
            font-weight: bold;
            font-size: 12px;
        }
        .invoice-box {
            border: 1px solid #999;
            padding: 8px 12px;
            font-size: 10px;
            width: 200px;
            float: right;
        }
        .invoice-box table {
            width: 100%;
        }
        .invoice-box td {
            padding: 2px 0;
        }
        .invoice-box .label {
            color: #666;
            font-weight: bold;
        }
        .invoice-box .value {
            text-align: right;
        }
        .invoice-title {
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            margin: 15px 0 10px;
        }

        /* Items table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            margin-top: 15px;
        }
        .items-table th {
            background-color: #e8e8e8;
            padding: 6px 10px;
            text-align: left;
            font-size: 10px;
            font-weight: bold;
            border-bottom: 1px solid #999;
        }
        .items-table th.amount {
            text-align: right;
        }
        .items-table td {
            padding: 4px 10px;
            vertical-align: top;
        }

        /* Horse header row */
        .horse-header td {
            font-weight: bold;
            padding-top: 10px;
            padding-bottom: 4px;
            font-size: 11px;
            background-color: #f5f5f5;
        }

        /* Livery item */
        .livery-item td {
            padding-left: 20px;
        }

        /* Extra charge item */
        .extra-item td {
            padding-left: 30px;
            font-size: 10px;
            color: #555;
        }

        .amount-col {
            text-align: right;
            white-space: nowrap;
        }

        /* Totals */
        .totals-section {
            width: 250px;
            margin-left: auto;
            margin-bottom: 20px;
        }
        .totals-section table {
            width: 100%;
            border-collapse: collapse;
        }
        .totals-section td {
            padding: 3px 0;
            font-size: 11px;
        }
        .totals-section .total-label {
            text-align: right;
            padding-right: 15px;
        }
        .totals-section .total-value {
            text-align: right;
            font-weight: bold;
        }
        .totals-section .amount-due {
            border-top: 2px solid #333;
            font-size: 13px;
            font-weight: bold;
            padding-top: 5px;
        }

        /* Payment details */
        .payment-section {
            background-color: #f5f5f5;
            padding: 12px 15px;
            margin-top: 20px;
            font-size: 10px;
            line-height: 1.6;
        }
        .payment-section h3 {
            margin: 0 0 6px;
            font-size: 11px;
        }
        .notes {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 10px;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            color: #999;
            font-size: 9px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="company-name">{{ settings.business_name }}</div>
        <div class="company-details">
            {% if settings.address %}{{ settings.address|linebreaksbr }}<br>{% endif %}
            {% if settings.phone %}Tel: {{ settings.phone }}<br>{% endif %}
            {% if settings.email %}{{ settings.email }}{% endif %}
            {% if settings.website %}<br>{{ settings.website }}{% endif %}
        </div>
    </div>

    <div class="invoice-title">Invoice</div>

    <!-- Two-column: Bill To + Invoice details box -->
    <div class="invoice-meta">
        <table>
            <tr>
                <td width="55%" class="bill-to">
                    <div class="owner-name">{{ invoice.owner.name }}</div>
                    {% if invoice.owner.address %}
                    <div>{{ invoice.owner.address|linebreaksbr }}</div>
                    {% endif %}
                </td>
                <td width="45%">
                    <div class="invoice-box">
                        <table>
                            <tr>
                                <td class="label">Invoice No:</td>
                                <td class="value">{{ invoice.invoice_number }}</td>
                            </tr>
                            <tr>
                                <td class="label">Date:</td>
                                <td class="value">{{ invoice.created_at|date:"d/m/Y" }}</td>
                            </tr>
                            {% if invoice.owner.account_code %}
                            <tr>
                                <td class="label">Account:</td>
                                <td class="value">{{ invoice.owner.account_code }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td class="label">VAT Reg:</td>
                                <td class="value">{{ settings.vat_registration|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <td class="label">Period:</td>
                                <td class="value">{{ invoice.period_start|date:"d/m/Y" }} - {{ invoice.period_end|date:"d/m/Y" }}</td>
                            </tr>
                            <tr>
                                <td class="label">Due Date:</td>
                                <td class="value">{{ invoice.due_date|date:"d/m/Y" }}</td>
                            </tr>
                        </table>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <!-- Items table: Item | Amount -->
    <table class="items-table">
        <thead>
            <tr>
                <th>Item</th>
                <th class="amount">Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for group in horse_groups %}
            <tr class="horse-header">
                <td colspan="2">{{ group.horse_name }}{% with share=group.items.0.share_percentage %}{% if share < 100 %} ({{ share|floatformat:0 }}% share){% endif %}{% endwith %}</td>
            </tr>
            {% for item in group.items %}
            {% if item.line_type == 'livery' %}
            <tr class="livery-item">
                <td>{{ item.description }}</td>
                <td class="amount-col">&pound;{{ item.line_total|floatformat:2 }}</td>
            </tr>
            {% else %}
            <tr class="extra-item">
                <td>{% if item.charge %}{{ item.charge.date|date:"d/m/Y" }}: {% endif %}{{ item.description }}</td>
                <td class="amount-col">&pound;{{ item.line_total|floatformat:2 }}</td>
            </tr>
            {% endif %}
            {% endfor %}
            {% endfor %}
        </tbody>
    </table>

    <!-- Totals -->
    <div class="totals-section">
        <table>
            <tr>
                <td class="total-label">Net Total:</td>
                <td class="total-value">&pound;{{ invoice.subtotal|floatformat:2 }}</td>
            </tr>
            <tr>
                <td class="total-label">VAT:</td>
                <td class="total-value">&pound;0.00</td>
            </tr>
            <tr>
                <td class="total-label amount-due">Amount Due:</td>
                <td class="total-value amount-due">&pound;{{ invoice.total|floatformat:2 }}</td>
            </tr>
        </table>
    </div>

    <!-- Payment Details -->
    {% if settings.bank_details %}
    <div class="payment-section">
        <h3>Payment Details</h3>
        {{ settings.bank_details|linebreaksbr }}
        {% if settings.card_payment_url %}
        <br>Or pay by card: {{ settings.card_payment_url }}
        {% endif %}
    </div>
    {% endif %}

    {% if invoice.notes %}
    <div class="notes">
        <strong>Notes:</strong><br>
        {{ invoice.notes|linebreaksbr }}
    </div>
    {% endif %}

    <div class="footer">
        Thank you for your business.
    </div>
</body>
</html>
